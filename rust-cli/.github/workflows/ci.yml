name: Diamond Drill CI

on:
  push:
    branches: [main]
    paths:
      - 'rust-cli/**'
  pull_request:
    branches: [main]
    paths:
      - 'rust-cli/**'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: rust-cli

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust-cli/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('rust-cli/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build
        run: cargo build --release --all-features

      - name: Unit tests
        run: cargo test --lib --all-features

      - name: Integration tests
        run: cargo test --test '*' --all-features
        env:
          ENVIRONMENT: development

  e2e-golden-path:
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: rust-cli

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Build release
        run: cargo build --release

      - name: E2E Golden Path Test
        run: |
          # Create test data
          mkdir -p /tmp/source
          echo "file1" > /tmp/source/file1.txt
          echo "file2" > /tmp/source/file2.md
          echo '{"key":"value"}' > /tmp/source/data.json

          # Run golden path: upload → analyze → export → verify
          ./target/release/diamond \
            --source /tmp/source \
            --dest /tmp/output.json \
            --ro-lock true \
            -vv

          # Verify output
          test -f /tmp/output.json || exit 1
          cat /tmp/output.json | jq .total_files | grep -q 3 || exit 1

          echo "✅ E2E Golden Path PASSED"
        env:
          ENVIRONMENT: development

  security-tests:
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: rust-cli

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Build
        run: cargo build --release

      - name: Test auth fail-safe (should panic in prod)
        run: |
          set +e
          ENVIRONMENT=production DISABLE_AUTH=true ./target/release/diamond --help
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 0 ]; then
            echo "❌ SECURITY FAIL: Auth disabled in production but app didn't panic!"
            exit 1
          fi

          echo "✅ Auth fail-safe working correctly"

      - name: Test auth ok in development
        run: |
          mkdir -p /tmp/test
          echo "test" > /tmp/test/file.txt

          ENVIRONMENT=development DISABLE_AUTH=true ./target/release/diamond \
            --source /tmp/test/file.txt \
            --dest /tmp/out.json

          echo "✅ Auth disabled allowed in development"
