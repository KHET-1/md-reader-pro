name: Performance Monitoring

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run performance tests daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read

jobs:
  performance-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v5
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Clean old benchmark logs
      run: |
        echo "🧹 Cleaning old benchmark logs..."
        rm -rf logs/benchmark-*.log || true
        mkdir -p logs
        echo "✅ Old logs cleaned"

    - name: Run basic tests first
      run: npm test

    - name: Run performance tests
      run: npm run test:performance

    - name: Run benchmarks and save log
      env:
        BENCHMARK_LOG_FILE: logs/benchmark-results.log
      run: |
        pwd
        npm run test:benchmarks > pr-benchmarks.log 2>&1 || true
        [ -f pr-benchmarks.log ] || touch pr-benchmarks.log
        ls -l pr-benchmarks.log || echo "pr-benchmarks.log not found, but continuing anyway"

    - name: Output benchmarks
      if: always()
      run: |
        if [ -f pr-benchmarks.log ]; then
          cat pr-benchmarks.log
        else
          echo "pr-benchmarks.log not found"
        fi

    - name: Run full performance monitoring
      run: npm run performance:monitor

    - name: Generate performance report
      run: |
        echo "## Performance Test Results" > performance-report.md
        echo "### Test Environment" >> performance-report.md
        echo "- Node.js: ${{ matrix.node-version }}" >> performance-report.md
        echo "- OS: Ubuntu Latest" >> performance-report.md
        echo "- Date: $(date)" >> performance-report.md
        echo "" >> performance-report.md
        echo "### Performance Metrics" >> performance-report.md
        echo "Tests completed successfully. See job logs for detailed metrics." >> performance-report.md

    - name: Upload performance report
      uses: actions/upload-artifact@v4
      with:
        name: performance-report-node-${{ matrix.node-version }}
        path: performance-report.md
        retention-days: 30

  performance-regression:
    runs-on: ubuntu-latest
    needs: performance-tests
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: 20
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Clean old benchmark logs
      run: |
        echo "🧹 Cleaning old benchmark logs..."
        rm -rf logs/benchmark-*.log || true
        mkdir -p logs
        echo "✅ Old logs cleaned"

    - name: Run regression detection
      env:
        BENCHMARK_LOG_FILE: logs/benchmark-regression.log
      run: |
        pwd
        npm run test:benchmarks > logs/benchmark-regression.log 2>&1 || true
        [ -f logs/benchmark-regression.log ] || touch logs/benchmark-regression.log
        ls -l logs/benchmark-regression.log || echo "logs/benchmark-regression.log not found, but continuing anyway"

    - name: Output regression benchmarks
      if: always()
      run: |
        if [ -f logs/benchmark-regression.log ]; then
          cat logs/benchmark-regression.log
        else
          echo "logs/benchmark-regression.log not found"
        fi

    - name: Check for performance regressions
      id: regression-check
      if: always()
      run: |
        if [ -f logs/benchmark-regression.log ]; then
          if grep -q "Slow test detected" logs/benchmark-regression.log; then
            echo "⚠️ Performance regression detected!"
            echo "See benchmark results for details."
            echo "regression_detected=true" >> $GITHUB_OUTPUT
          else
            echo "✅ No performance regressions detected."
            echo "regression_detected=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "⚠️ Could not check for regressions - log file not found"
          echo "regression_detected=false" >> $GITHUB_OUTPUT
        fi

    - name: Comment PR with results
      if: always() && steps.regression-check.outputs.regression_detected == 'true'
      uses: actions/github-script@v8
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '⚠️ **Performance Regression Detected**\n\nThe performance tests indicate potential regressions. Please review the performance test results in the Actions log.'
          })

  memory-leak-detection:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Node.js with memory monitoring
      uses: actions/setup-node@v5
      with:
        node-version: 20
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run memory leak detection
      run: |
        echo "Running memory leak detection..."
        node --expose-gc --max-old-space-size=512 ./node_modules/.bin/jest tests/benchmarks.test.js --verbose --runInBand

    - name: Check memory usage
      run: |
        echo "Checking for memory leaks in test output..."
        # TODO: Implement actual memory leak detection logic
        echo "Memory leak detection completed."

  performance-comparison:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read

    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v5

    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: 20
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Clean old benchmark logs
      run: |
        echo "🧹 Cleaning old benchmark logs..."
        rm -rf logs/benchmark-*.log || true
        mkdir -p logs
        echo "✅ Old logs cleaned"
        
    - name: Run PR benchmarks
      env:
        BENCHMARK_LOG_FILE: logs/benchmark-pr.log
      run: |
        pwd
        npm run test:benchmarks > pr-benchmarks.log 2>&1 || true
        [ -f pr-benchmarks.log ] || touch pr-benchmarks.log
        ls -l pr-benchmarks.log || echo "pr-benchmarks.log not found, but continuing anyway"

    - name: Output PR benchmarks
      if: always()
      run: |
        if [ -f pr-benchmarks.log ]; then
          cat pr-benchmarks.log
        else
          echo "pr-benchmarks.log not found"
        fi

    - name: Checkout main branch
      uses: actions/checkout@v5
      with:
        ref: main

    - name: Install dependencies (main)
      run: npm ci

    - name: Clean old benchmark logs (main)
      run: |
        echo "🧹 Cleaning old benchmark logs..."
        rm -rf logs/benchmark-*.log || true
        mkdir -p logs
        echo "✅ Old logs cleaned"

    - name: Run main benchmarks
      env:
        BENCHMARK_LOG_FILE: logs/benchmark-main.log
      run: |
        pwd
        npm run test:benchmarks > main-benchmarks.log 2>&1 || true
        [ -f main-benchmarks.log ] || touch main-benchmarks.log
        ls -l main-benchmarks.log || echo "main-benchmarks.log not found, but continuing anyway"

    - name: Output main benchmarks
      if: always()
      run: |
        if [ -f main-benchmarks.log ]; then
          cat main-benchmarks.log
        else
          echo "main-benchmarks.log not found"
        fi

    - name: Compare performance
      run: |
        echo "## Performance Comparison" > comparison.md
        echo "### PR Branch vs Main Branch" >> comparison.md
        echo "" >> comparison.md
        echo "#### Main Branch Results:" >> comparison.md
        echo "\`\`\`" >> comparison.md
        if [ -f main-benchmarks.log ]; then
          cat main-benchmarks.log >> comparison.md || echo "Error reading main-benchmarks.log" >> comparison.md
        else
          echo "main-benchmarks.log not found - benchmark tests may have failed" >> comparison.md
        fi
        echo "\`\`\`" >> comparison.md
        echo "" >> comparison.md
        echo "#### PR Branch Results:" >> comparison.md
        echo "\`\`\`" >> comparison.md
        if [ -f pr-benchmarks.log ]; then
          cat pr-benchmarks.log >> comparison.md || echo "Error reading pr-benchmarks.log" >> comparison.md
        else
          echo "pr-benchmarks.log not found - benchmark tests may have failed" >> comparison.md
        fi
        echo "\`\`\`" >> comparison.md

    - name: Upload comparison
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: performance-comparison
        path: comparison.md
